---
title: "API Reference -> Intercom -> User Hash"
description: "Generate HMAC hash for Intercom identity verification"
---

```mdx
---
title: 'Intercom User Hash'
api: 'POST /intercom/user-hash'
description: 'Generate HMAC hash for Intercom identity verification'
---

Endpoint
```

POST /make-server-4010be06/intercom/user-hash

```

Generate a secure HMAC-SHA256 hash for Intercom identity verification. Required for secure Intercom integration to prevent user impersonation.

<Warning>
Security-critical endpoint. Never expose the identity verification secret in frontend code!
</Warning>

---

Headers

<ParamField header="Authorization" type="string" required>
  Bearer token
  
```

Authorization: Bearer YOUR_ACCESS_TOKEN

````
</ParamField>

---

Request Body

No request body required. User ID is extracted from the auth token.

---

Response

<ResponseField name="userHash" type="string">
HMAC-SHA256 hash of user ID

Example: `"abc123def456..."`
</ResponseField>

---

Example Request

```typescript
const response = await fetch('https://YOUR_PROJECT.supabase.co/functions/v1/make-server-4010be06/intercom/user-hash', {
method: 'POST',
headers: {
  'Authorization': `Bearer ${accessToken}`,
  'Content-Type': 'application/json'
}
})

const { userHash } = await response.json()

// Use in Intercom boot
Intercom({
app_id: INTERCOM_APP_ID,
user_id: profile.id,
user_hash: userHash,  // ← Security!
name: profile.name,
email: profile.email
})
````

---

Example Response

```json
{
  "userHash": "9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08"
}
```

---

Error Responses

<ResponseExample>

```json 401 - Unauthorized
{
  "error": "Unauthorized"
}
```


```json 500 - Secret Not Configured
{
  "error": "Not configured",
  "details": "Intercom identity verification secret not set"
}
```

</ResponseExample>

---

How It Works

1. User Authenticates

```typescript
const { session } = await signIn(email, password)
const accessToken = session.access_token
```

2. Frontend Requests Hash

```typescript
const { userHash } = await fetch('/intercom/user-hash', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${accessToken}` }
}).then(r => r.json())
```

3. Backend Generates Hash

```typescript
// Server-side (DO NOT DO THIS IN FRONTEND!)
const secret = Deno.env.get('INTERCOM_IDENTITY_VERIFICATION_SECRET')
const userId = user.id

const encoder = new TextEncoder()
const key = await crypto.subtle.importKey(
  'raw',
  encoder.encode(secret),
  { name: 'HMAC', hash: 'SHA-256' },
  false,
  ['sign']
)

const signature = await crypto.subtle.sign(
  'HMAC',
  key,
  encoder.encode(userId)
)

const hashArray = Array.from(new Uint8Array(signature))
const userHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('')

return { userHash }
```

4. Frontend Boots Intercom

```typescript
Intercom({
  app_id: 'YOUR_APP_ID',
  user_id: profile.id,
  user_hash: userHash,  // Intercom verifies this matches!
  // ... other attributes
})
```

5. Intercom Verifies

Intercom generates the same hash using the secret and user ID. If they match, the user is verified.

---

Security Benefits

<AccordionGroup>
  <Accordion title="Prevents Impersonation" icon="user-shield">
    Without identity verification, an attacker could pretend to be another user by simply changing the `user_id` in Intercom config.

    With verification, Intercom checks the hash and rejects invalid users.
  </Accordion>
  <Accordion title="Server-Side Only Secret" icon="lock">
    The identity verification secret never leaves the server. Frontend only receives the hash, which is useless without the secret.
  </Accordion>
  <Accordion title="Per-User Hashes" icon="fingerprint">
    Each user has a unique hash based on their user ID. Hashes cannot be reused for other users.
  </Accordion>
</AccordionGroup>

---

Setup Requirements

1. Enable Identity Verification in Intercom

Go to Intercom Dashboard → Settings → Security Enable "Identity Verification" Copy the secret key

2. Set Supabase Secret

```bash
supabase secrets set INTERCOM_IDENTITY_VERIFICATION_SECRET=your_secret_key
```

3. Deploy Edge Functions

```bash
supabase functions deploy server
```

---

Integration with bootIntercom

The hash is automatically fetched in `utils/intercom.tsx`:

```typescript
async function fetchUserHash(accessToken: string): Promise<string | null> {
  try {
    const response = await fetch('/intercom/user-hash', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      }
    })
    
    if (!response.ok) {
      console.warn('Failed to fetch user hash')
      return null
    }
    
    const { userHash } = await response.json()
    return userHash
    
  } catch (error) {
    console.warn('Error fetching user hash:', error)
    return null
  }
}

export async function bootIntercom(profile: Profile, email: string, accessToken: string) {
  // Fetch hash
  const userHash = await fetchUserHash(accessToken)
  
  // Boot Intercom
  Intercom({
    app_id: INTERCOM_APP_ID,
    user_id: profile.id,
    user_hash: userHash,  // Include hash
    name: profile.name,
    email: email
  })
}
```

---

Error Handling

```typescript
async function bootIntercomWithVerification() {
  try {
    // Attempt to get hash
    const { userHash } = await fetch('/intercom/user-hash', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${accessToken}` }
    }).then(r => r.json())
    
    // Boot with verification
    Intercom({
      app_id: INTERCOM_APP_ID,
      user_id: profile.id,
      user_hash: userHash,
      // ...
    })
    
  } catch (error) {
    console.warn('Identity verification failed, booting without hash')
    
    // Boot without verification (development only!)
    if (import.meta.env.DEV) {
      Intercom({
        app_id: INTERCOM_APP_ID,
        user_id: profile.id,
        // No user_hash
      })
    }
  }
}
```

---

Testing

Development

```typescript
// Skip verification in development if secret not configured
if (import.meta.env.DEV && !userHash) {
  console.log('DEV: Booting Intercom without identity verification')
  Intercom({ app_id, user_id, name, email })
  return
}
```

Production

```typescript
// Require verification in production
if (import.meta.env.PROD && !userHash) {
  console.error('PROD: Cannot boot Intercom without identity verification')
  return
}
```

---

Notes

<Warning>
  NEVER store the `INTERCOM_IDENTITY_VERIFICATION_SECRET` in frontend code or environment variables accessible to the client!
</Warning>

<Info>
  If identity verification is not configured, Intercom will still work but without security. Always enable it in production!
</Info>

<Tip>
  Test identity verification by attempting to change `user_id` in browser DevTools. Intercom should reject the connection.
</Tip>

---

Next Steps

<CardGroup cols={2}>
  <Card title="Intercom Setup" icon="messages" href="/technical/integrations/intercom">
    Complete integration guide
  </Card>
  <Card title="Sign In" icon="arrow-right-to-bracket" href="/api-reference/auth/signin">
    Get access token
  </Card>
  <Card title="Security" icon="shield" href="/technical/security">
    Security best practices
  </Card>
</CardGroup>