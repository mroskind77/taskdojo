```mdx
---
title: Database Schema
description: Complete database design and data models for Task Dojo
---

Database Overview

Task Dojo uses a single-table key-value store design backed by PostgreSQL, combined with Supabase Auth for user management.

Architecture:
Storage: PostgreSQL (via Supabase)
Pattern: Key-value store (single table)
Auth: Supabase Auth (separate system)
Schema: Flexible JSONB values

---

Core Table: kv_store_4010be06

Table Definition

```sql
CREATE TABLE kv_store_4010be06 (
  key TEXT PRIMARY KEY,
  value JSONB NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Trigger to auto-update updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_kv_store_updated_at
  BEFORE UPDATE ON kv_store_4010be06
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

Indexes

```sql
-- Index for prefix queries (e.g., all tasks for a user)
CREATE INDEX idx_kv_prefix ON kv_store_4010be06 
  USING btree (key text_pattern_ops);

-- Index for JSONB queries (if needed)
CREATE INDEX idx_kv_value ON kv_store_4010be06 
  USING gin (value);

-- Index for timestamp queries
CREATE INDEX idx_kv_created_at ON kv_store_4010be06 (created_at);
CREATE INDEX idx_kv_updated_at ON kv_store_4010be06 (updated_at);
```

---

Key Patterns

Naming Convention

All keys follow the pattern: `{entity}:{id}` or `{entity}:{userId}:{id}`

Examples:
```
profile:550e8400-e29b-41d4-a716-446655440000
task:550e8400-e29b-41d4-a716-446655440000:task-123
insights:550e8400-e29b-41d4-a716-446655440000
template:morning-routine
```

Key Prefixes

| Prefix | Purpose | Example |
|--------|---------|---------|
| `profile:` | User profiles | `profile:{userId}` |
| `task:` | User tasks | `task:{userId}:{taskId}` |
| `insights:` | Cached insights | `insights:{userId}` |
| `template:` | Template library | `template:{categoryId}` |
| `achievement:` | User achievements | `achievement:{userId}:{achievementId}` |
| `avatar:` | Avatar skins | `avatar:{userId}` |
| `grace:` | Grace token tracking | `grace:{userId}` |
| `streak:` | Streak history | `streak:{userId}:{date}` |

---

Data Models

Profile

Key: `profile:{userId}`

Schema:

```typescript
interface Profile {
  // Identity
  id: string                    // User ID (from Supabase Auth)
  email: string                 // User email
  name: string                  // Display name
  
  // Account type
  userType: 'master' | 'sensei' | 'disciple'
  ageCategory: 'grasshopper' | 'cricket' | 'stickbug' | 'mantis'
  
  // Progression
  points: number                // Total points earned
  beltLevel: string             // Current belt: white-black
  streak: number                // Current consecutive days
  longestStreak: number         // All-time longest streak
  
  // Timestamps
  createdAt: string             // ISO 8601 timestamp
  lastActiveDate: string        // Last activity date
  lastStreakUpdate: string      // Last streak calculation
  
  // Relationships (Sensei/Disciple)
  senseiId: string | null       // Sensei ID (for disciples)
  disciples: string[]           // Array of disciple IDs (for senseis)
  
  // Grace Tokens & Streak Savior
  graceTokensAvailable: number  // 0-2 tokens
  lastGraceTokenReset: string   // Rolling window start
  streakSaviorOffered: boolean  // Rescue quest offered?
  rescueQuestActive: boolean    // Currently in rescue quest?
  rescueQuestExpiry: string | null // When rescue expires
  
  // Avatar & Customization
  selectedAvatar: string        // Avatar skin ID
  unlockedAvatars: string[]     // All unlocked avatars
  
  // Statistics (cached for performance)
  totalTasksCompleted: number   // All-time completions
  totalTasksCreated: number     // All-time created
  earlyCompletions: number      // Completed before due date
  focusSessionsCompleted: number // Focus timer sessions
  
  // Sensei-specific
  discipleCount: number         // Number of disciples
  totalApprovals: number        // Lifetime approvals given
  
  // Settings & Preferences
  timezone: string              // User timezone (IANA)
  notificationsEnabled: boolean // Email notifications
  soundEffectsEnabled: boolean  // Audio feedback
  reducedMotion: boolean        // Accessibility
  dyslexiaFont: boolean         // Font preference
  fontSize: number              // 100-150%
  highContrast: boolean         // Contrast mode
}
```

Example:

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "email": "alex@example.com",
  "name": "Alex",
  "userType": "disciple",
  "ageCategory": "cricket",
  "points": 425,
  "beltLevel": "orange",
  "streak": 12,
  "longestStreak": 18,
  "createdAt": "2024-01-15T08:00:00Z",
  "lastActiveDate": "2024-02-10T19:30:00Z",
  "lastStreakUpdate": "2024-02-10T00:00:00Z",
  "senseiId": "parent-user-id-here",
  "disciples": [],
  "graceTokensAvailable": 2,
  "lastGraceTokenReset": "2024-02-03T00:00:00Z",
  "streakSaviorOffered": false,
  "rescueQuestActive": false,
  "rescueQuestExpiry": null,
  "selectedAvatar": "cricket",
  "unlockedAvatars": ["cricket", "dojo-spirit", "grasshopper", "yellow-belt-spirit"],
  "totalTasksCompleted": 67,
  "totalTasksCreated": 82,
  "earlyCompletions": 12,
  "focusSessionsCompleted": 5,
  "discipleCount": 0,
  "totalApprovals": 0,
  "timezone": "America/New_York",
  "notificationsEnabled": true,
  "soundEffectsEnabled": true,
  "reducedMotion": false,
  "dyslexiaFont": false,
  "fontSize": 100,
  "highContrast": false
}
```

---

Task

Key: `task:{userId}:{taskId}`

Schema:

```typescript
interface Task {
  // Identity
  id: string                    // Unique task ID (UUID)
  userId: string                // Owner user ID
  
  // Content
  title: string                 // Task title (max 200 chars)
  description: string | null    // Optional description
  
  // Categorization
  category: 'morning' | 'school' | 'afterschool' | 'nighttime'
  icon: string                  // Lucide icon name
  
  // Difficulty & Points
  difficulty: 'easy' | 'medium' | 'hard' | 'epic'
  points: number                // Base points: 10, 25, 50, 100
  
  // Scheduling
  dueDate: string | null        // ISO 8601 date (optional)
  dueTime: string | null        // HH:MM format (optional)
  recurring: boolean            // Future: recurring tasks
  recurrencePattern: string | null // Future: RRULE
  
  // Status
  completed: boolean            // Completion status
  approved: boolean             // Approval status (disciples only)
  
  // Completion metadata
  completedAt: string | null    // When completed
  quality: number | null        // Quality rating 1-5
  qualityRatedBy: 'self' | 'sensei' | null
  
  // Approval metadata (disciples)
  approvedAt: string | null     // When approved
  approvedBy: string | null     // Sensei ID who approved
  senseiNote: string | null     // Sensei feedback
  senseiNoteAt: string | null   // Note timestamp
  
  // Timeliness (future feature)
  timeliness: 'early' | 'on-time' | 'late' | 'very-late' | 'no-due-date' | null
  timelinessModifier: number | null // Point modifier
  
  // Breakdown
  isSubTask: boolean            // Part of AI breakdown?
  parentTaskId: string | null   // Parent task if sub-task
  subTaskIds: string[]          // Child tasks if parent
  
  // Focus Timer
  focusSessionUsed: boolean     // Used focus timer?
  focusSessionDuration: number | null // Minutes
  
  // Timestamps
  createdAt: string             // Creation timestamp
  updatedAt: string             // Last update
  
  // Soft delete (future)
  deleted: boolean              // Soft delete flag
  deletedAt: string | null      // Deletion timestamp
}
```

Example:

```json
{
  "id": "task-abc-123",
  "userId": "550e8400-e29b-41d4-a716-446655440000",
  "title": "Complete math homework",
  "description": "Finish problems 1-20 on page 45",
  "category": "afterschool",
  "icon": "BookOpen",
  "difficulty": "medium",
  "points": 25,
  "dueDate": "2024-02-11",
  "dueTime": "18:00",
  "recurring": false,
  "recurrencePattern": null,
  "completed": true,
  "approved": true,
  "completedAt": "2024-02-10T17:30:00Z",
  "quality": 4,
  "qualityRatedBy": "sensei",
  "approvedAt": "2024-02-10T20:00:00Z",
  "approvedBy": "parent-user-id-here",
  "senseiNote": "Great work! I can see you really focused on this. Keep it up!",
  "senseiNoteAt": "2024-02-10T20:00:00Z",
  "timeliness": "early",
  "timelinessModifier": 0.2,
  "isSubTask": false,
  "parentTaskId": null,
  "subTaskIds": [],
  "focusSessionUsed": true,
  "focusSessionDuration": 20,
  "createdAt": "2024-02-09T15:00:00Z",
  "updatedAt": "2024-02-10T20:00:00Z",
  "deleted": false,
  "deletedAt": null
}
```

---

Insights (Cached)

Key: `insights:{userId}`

Purpose: Cached analytics for Sensei Insights dashboard

Schema:

```typescript
interface InsightsData {
  userId: string
  generatedAt: string           // Cache timestamp
  expiresAt: string            // Cache expiry
  
  // Summary stats
  totalTasks: number
  completedTasks: number
  completionRate: number        // Percentage
  averageQuality: number        // 1-5 scale
  
  // Breakdown by category
  tasksByCategory: {
    morning: number
    school: number
    afterschool: number
    nighttime: number
  }
  
  // Time of day analysis
  tasksByTimeOfDay: {
    morning: number              // 6am-12pm
    afternoon: number            // 12pm-5pm
    evening: number              // 5pm-9pm
    night: number                // 9pm-12am
  }
  
  // Trends
  qualityTrend: Array<{
    date: string                // YYYY-MM-DD
    avgQuality: number
  }>
  
  // Streak history
  streakHistory: Array<{
    date: string
    active: boolean              // Had completion?
  }>
  
  // Current state snapshot
  currentStreak: number
  currentBelt: string
  totalPoints: number
}
```

Cache TTL: 5 minutes

Invalidation: On task completion, approval, or profile update

---

Template

Key: `template:{categoryId}`

Purpose: Preset task templates for quick creation

Schema:

```typescript
interface Template {
  id: string                    // Template ID
  name: string                  // Display name
  category: string              // Category/type
  ageCategories: string[]       // Suitable for which ages
  description: string           // Template description
  
  tasks: Array<{
    title: string
    category: 'morning' | 'school' | 'afterschool' | 'nighttime'
    difficulty: 'easy' | 'medium' | 'hard' | 'epic'
    points: number
    icon: string
    description?: string
    dueTime?: string
  }>
  
  createdBy: 'system' | string  // System or user ID
  public: boolean               // Available to all?
  usageCount: number            // How many times used
}
```

Example:

```json
{
  "id": "morning-routine-cricket",
  "name": "Morning Routine (Ages 9-12)",
  "category": "routines",
  "ageCategories": ["cricket"],
  "description": "Standard morning routine for 9-12 year olds",
  "tasks": [
    {
      "title": "Make bed",
      "category": "morning",
      "difficulty": "easy",
      "points": 10,
      "icon": "Bed",
      "dueTime": "08:00"
    },
    {
      "title": "Brush teeth",
      "category": "morning",
      "difficulty": "easy",
      "points": 10,
      "icon": "Sparkles",
      "dueTime": "08:15"
    },
    {
      "title": "Eat breakfast",
      "category": "morning",
      "difficulty": "easy",
      "points": 10,
      "icon": "Utensils",
      "dueTime": "08:30"
    }
  ],
  "createdBy": "system",
  "public": true,
  "usageCount": 1247
}
```

---

Supabase Auth Tables

auth.users

Managed by Supabase - Do not modify directly

Key fields:
```typescript
{
  id: string                    // User ID (UUID)
  email: string                 // Email address
  encrypted_password: string    // Hashed password
  email_confirmed_at: timestamp // Confirmation time
  created_at: timestamp
  updated_at: timestamp
  last_sign_in_at: timestamp
  
  // User metadata (custom)
  user_metadata: {
    name: string
    userType: string
    ageCategory: string
  }
}
```

Access:
✅ Server-side only (via SERVICE_ROLE_KEY)
❌ Never query from frontend

---

Query Patterns

Get Single Record

```typescript
const profile = await kv.get(`profile:${userId}`)
```

Complexity: O(1) - Direct key lookup

---

Get By Prefix (Multiple Records)

```typescript
// Get all tasks for a user
const tasks = await kv.getByPrefix(`task:${userId}:`)

// Get all profiles (admin only)
const allProfiles = await kv.getByPrefix('profile:')
```

Complexity: O(n) where n = matching keys

Optimization: Use LIMIT in production

```typescript
async function getByPrefix(prefix: string, options = { limit: 100 }) {
  const { data } = await supabase
    .from('kv_store_4010be06')
    .select('key, value')
    .like('key', `${prefix}%`)
    .limit(options.limit)
    .order('created_at', { ascending: false })
  
  return data.map(row => JSON.parse(row.value))
}
```

---

Batch Operations

```typescript
// Get multiple specific keys
async function mget(keys: string[]) {
  const { data } = await supabase
    .from('kv_store_4010be06')
    .select('key, value')
    .in('key', keys)
  
  return data.map(row => JSON.parse(row.value))
}

// Set multiple at once
async function mset(entries: Record<string, any>) {
  const rows = Object.entries(entries).map(([key, value]) => ({
    key,
    value: JSON.stringify(value)
  }))
  
  const { error } = await supabase
    .from('kv_store_4010be06')
    .upsert(rows)
  
  if (error) throw error
}
```

---

Data Lifecycle

Create Flow

```typescript
// 1. Generate ID
const userId = crypto.randomUUID()

// 2. Create profile
const profile: Profile = {
  id: userId,
  email: 'user@example.com',
  name: 'John',
  userType: 'master',
  ageCategory: 'mantis',
  points: 0,
  beltLevel: 'white',
  streak: 0,
  // ... other fields with defaults
  createdAt: new Date().toISOString(),
  lastActiveDate: new Date().toISOString()
}

// 3. Store
await kv.set(`profile:${userId}`, profile)
```

Update Flow

```typescript
// 1. Fetch current
const profile = await kv.get(`profile:${userId}`)

// 2. Modify
profile.points += 25
profile.beltLevel = calculateBelt(profile.points, profile.ageCategory)

// 3. Save
await kv.set(`profile:${userId}`, profile)
```

Delete Flow

```typescript
// Hard delete
await kv.del(`task:${userId}:${taskId}`)

// Soft delete (preferred)
const task = await kv.get(`task:${userId}:${taskId}`)
task.deleted = true
task.deletedAt = new Date().toISOString()
await kv.set(`task:${userId}:${taskId}`, task)
```

---

Performance Considerations

Indexing Strategy

Primary key (exact match): Lightning fast
`profile:{userId}` ✅
`task:{userId}:{taskId}` ✅

Prefix queries (pattern match): Fast with index
`task:{userId}:%` ✅
With `idx_kv_prefix` index

JSONB queries: Moderate speed
`value->>'category' = 'morning'` ⚠️
With `idx_kv_value` GIN index

Full table scans: Slow, avoid
`SELECT * FROM kv_store` ❌

Caching

What to cache:
✅ Insights (5-minute TTL)
✅ Template library (1-hour TTL)
✅ Avatar unlocks (session-level)

What NOT to cache:
❌ User profiles (always fresh)
❌ Tasks (real-time updates)
❌ Streaks (daily calculation)

Pagination

```typescript
async function getTasks(userId: string, page = 0, pageSize = 50) {
  let allTasks = await kv.getByPrefix(`task:${userId}:`)
  
  // Filter out soft-deleted
  allTasks = allTasks.filter(t => !t.deleted)
  
  // Sort by created date
  allTasks.sort((a, b) => 
    new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
  )
  
  // Paginate
  const start = page * pageSize
  const tasks = allTasks.slice(start, start + pageSize)
  
  return {
    tasks,
    pagination: {
      page,
      pageSize,
      total: allTasks.length,
      hasMore: (start + pageSize) < allTasks.length
    }
  }
}
```

---

Backup & Recovery

Automated Backups

Supabase provides automatic backups:
Daily backups: Last 7 days
Point-in-time recovery: Up to 30 days (paid plans)

Manual Export

```sql
-- Export entire table
COPY kv_store_4010be06 TO '/tmp/backup.csv' WITH CSV HEADER;

-- Export specific prefix
COPY (
  SELECT * FROM kv_store_4010be06 
  WHERE key LIKE 'profile:%'
) TO '/tmp/profiles_backup.csv' WITH CSV HEADER;
```

Data Migration

```typescript
// Migrate data shape
async function migrateProfiles() {
  const profiles = await kv.getByPrefix('profile:')
  
  for (const profile of profiles) {
    // Add new field
    if (!profile.timezone) {
      profile.timezone = 'America/New_York'
    }
    
    // Rename field
    if (profile.completedTasks) {
      profile.totalTasksCompleted = profile.completedTasks
      delete profile.completedTasks
    }
    
    await kv.set(`profile:${profile.id}`, profile)
  }
}
```

---

Related Documentation

<CardGroup cols={2}>
  <Card title="Architecture" icon="sitemap" href="/technical/architecture">
    System architecture overview
  </Card>
  <Card title="API Reference" icon="code" href="/api-reference/overview">
    API endpoint documentation
  </Card>
  <Card title="Data Access" icon="database" href="/technical/development/data-access">
    KV store utilities
  </Card>
  <Card title="Security" icon="shield" href="/technical/security">
    Data security practices
  </Card>
</CardGroup>
```
